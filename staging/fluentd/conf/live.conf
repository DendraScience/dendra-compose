<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

<match **>
  @type copy

  <store>
    @type relabel
    @label @SLACK
  </store>

  <store>
    @type mongo
    host fluentd-mongo
    database "#{ENV['MONGO_DB_NAME']}"

    user "#{ENV['MONGO_DB_USER']}"
    password "#{ENV['MONGO_DB_PASS']}"

    capped
    capped_size 512m
    collection ${tag}

    <buffer>
      @type file
      path /fluentd/log/mongo.*.buffer
    </buffer>
  </store>
</match>

<label @SLACK>
  <filter worker.**>
    @type grep

    <regexp>
      key log
      pattern ^error:
    </regexp>
    <exclude>
      key log
      pattern ^error: Agent \[goes_import\w+\]: (DDS client block request error \| Error: Server error \(35\): Until Reached|DDS client error \| Error: Request timed out)$
    </exclude>
  </filter>

  <match worker.**>
    @type slack

    webhook_url "#{ENV['FLUENTD_SLACK_WEBHOOK_URL']}"
    channel live-logs
    username dendra

    message `%s` `%s` %s
    message_keys time,container_name,log

    flush_interval 60s
  </match>
</label>
